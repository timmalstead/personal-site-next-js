version: 2.1
orbs:
    onepassword: onepassword/secrets@1.0.0
    docker: circleci/docker@2.6.0
jobs:
    build_next_js:
        docker:
            - image: cimg/base:current
        resource_class: medium
        steps:
            - onepassword/install-cli:
                  version: 2.18.0
            - onepassword/export:
                  var-name: REGISTRY
                  secret-reference: op://personal-site-gcp/artifact-registry-creds/registry
            - onepassword/export:
                  var-name: IMAGE
                  secret-reference: op://personal-site-gcp/artifact-registry-creds/next-js-image
            - onepassword/export:
                  var-name: DOCKER_LOGIN
                  secret-reference: op://personal-site-gcp/artifact-registry-creds/username
            - onepassword/export:
                  var-name: DOCKER_PASSWORD
                  secret-reference: op://personal-site-gcp/pulumiCircleCiService/key
            - setup_remote_docker
            - checkout
            - run:
                  name: Persist latest build sha
                  command: op item edit latest_next_js sha=$CIRCLE_SHA1
            - docker/check:
                  registry: $REGISTRY
            - docker/build:
                  image: $REGISTRY/$IMAGE
            - docker/push:
                  registry: $REGISTRY
                  image: $IMAGE
            - run:
                  name: Persist latest build sha
                  command: op item edit latest_next_js sha=$CIRCLE_SHA1
            # - run:
            #       name: Trigger infra build pipeline
            #       command: |
            #           curl --request POST \
            #             --url "https://circleci.com/api/v2/project/gh/timmalstead/personal-site-gcp-infra/pipeline" \
            #             --header "Circle-Token: $(op read op://personal-site-gcp/circle-ci-api-use/token)"
workflows:
    build:
        jobs:
            - build_next_js:
                  context:
                      - personal_site
